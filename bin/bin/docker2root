#!/bin/bash
set -euo pipefail

container=$1

TMPDIR=/bigdisk/tmp
CONTAINERDIR=/bigdisk/containers2
GETIMAGE=/home/motiejus/bin/download-frozen-image-v2.sh

log() {
    local arg1=$1
    shift
    >&2 echo "$arg1" "$*"
}

dir="$CONTAINERDIR/$container"
if [[ -d "$dir" ]]; then
    if [[ -f "$dir/.extract_done" ]]; then
        log "$dir already has the filesystem extracted"
        exit 0
    fi

    if [[ ! -f "$dir/.extract_started" ]]; then
        log "$dir exists and does not have magic file, bailing"
        exit 1
    else
        log "Deleting btrfs subvolume $dir"
        btrfs subvolume delete "$dir"
    fi
fi
log -n "Creating $dir ..."
mkdir -p "$(dirname "$dir")"
btrfs subvolume create "$dir"
log "done"
touch "$dir/.extract_started"

tmpdir=$(mktemp -d -p "$TMPDIR" $(basename "$container")XXXXX)
cleanup() {
    log -n "Removing $tmpdir... "
    rm -fr "$tmpdir"
    log "done"
}
trap cleanup EXIT
log "Downloading $container to $tmpdir..."
"$GETIMAGE" "$tmpdir" "$container"
log -n "Extracting $tmpdir to $dir... "
jq -r '.[] | .Layers | .[]' "$tmpdir/manifest.json" | xargs -I{} tar -C "$dir" -xf $tmpdir/{}
log "done"
touch "$dir/.extract_done"
cleanup
trap - EXIT
