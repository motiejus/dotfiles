#!/bin/bash
set -euo pipefail

container=$1

TMPDIR=/bigdisk/tmp
CONTAINERDIR=/bigdisk/containers2
GETIMAGE=download-frozen-image-v2.sh

log() {
    local arg1=$1
    shift
    >&2 echo "$arg1" "$*"
}

dir="$CONTAINERDIR/$container"
if [[ -d "$dir" ]]; then
    if [[ -f "$dir/.extract_done" ]]; then
        log "$dir already has the filesystem extracted"
        exit 0
    fi

    if [[ ! -f "$dir/.extract_started" ]]; then
        log "$dir exists and does not have magic file, bailing"
        exit 1
    else
        log "Deleting btrfs subvolume $dir"
        btrfs subvolume delete "$dir"
    fi
fi
log -n "Creating $dir ..."
mkdir -p "$(dirname "$dir")"
btrfs subvolume create "$dir"
log "done"
touch "$dir/.extract_started"

tmpdir=$(mktemp -d -p "$TMPDIR" $(basename "$container")XXXXX)
cleanup() {
    log -n "Removing $tmpdir... "
    rm -fr "$tmpdir"
    log "done"
}
trap cleanup EXIT
log "Downloading $container to $tmpdir..."
"$GETIMAGE" "$tmpdir" "$container"
log -n "Extracting $tmpdir to $dir... "
jq -r '.[] | .Layers | .[]' "$tmpdir/manifest.json" | xargs -I{} tar -C "$dir" -xf $tmpdir/{}
log "done"

log -n "Writing $dir/docker2root_entrypoint.sh and $dir/docker2root_cmd.sh... "
cfg=$(jq -r '.[].Config' "$tmpdir/manifest.json")
entrypoint=$(jq -r 'if(.config.Entrypoint == null) then "" else .config.Entrypoint | join(" ") end' "$tmpdir/$cfg")
cmd=$(jq -r 'if(.config.Cmd == null) then "" else .config.Cmd | join(" ") end' "$tmpdir/$cfg")
echo -e '#!/bin/sh\n\n'"exec $entrypoint" > "$dir/docker2root_entrypoint.sh"
echo -e '#!/bin/sh\n\n'"exec $cmd" > "$dir/docker2root_cmd.sh"
chmod a+x "$dir/docker2root_entrypoint.sh" "$dir/docker2root_cmd.sh"
log " done"

touch "$dir/.extract_done"
cleanup
trap - EXIT
